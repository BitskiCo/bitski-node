{"version":3,"file":"bitski-provider.es5.js","sources":["../src/access-token.ts","../src/oauth-http-provider.ts","../src/bitski-provider.ts"],"sourcesContent":["/**\n * A token that provides access to Bitski on behalf of a user.\n */\nexport class AccessToken {\n  public token: string;\n  public expiresAt?: number = undefined;\n\n  get expired(): boolean {\n    if (this.expiresAt) {\n      const now = Math.floor(Date.now() / 1000);\n      const expiresIn = this.expiresAt - now;\n      return expiresIn <= 0;\n    }\n    return false;\n  }\n\n  constructor(token: string, expiresIn?: number) {\n    this.token = token;\n    if (expiresIn && expiresIn > 0) {\n        let now = Math.floor(Date.now() / 1000);\n        this.expiresAt = now + expiresIn;\n    }\n  }\n}\n","import XMLHttpRequest from 'xhr2';\nimport { AccessToken } from './access-token';\n\n/**\n * A class that extends Web3's HTTPProvider by adding OAuth to JSON-RPC calls.\n */\nexport class OAuthHttpProvider {\n  /**\n   * The access token for the current logged in user\n   */\n  accessToken?: AccessToken = undefined;\n\n  /**\n   * The JSON-RPC endpoint\n   */\n  host: string;\n  timeout: number;\n  headers?: [any];\n\n  /**\n   * @param host JSON-RPC endpoint\n   * @param timeout Timeout in seconds\n   * @param additionalHeaders Optional headers to include with every request\n   */\n  constructor(host: string, timeout?: number, additionalHeaders?: [any]) {\n    this.host = host;\n    this.timeout = timeout || 0;\n    this.headers = additionalHeaders;\n  }\n\n  public setAccessToken(accessToken?: AccessToken): void {\n    this.accessToken = accessToken;\n  }\n\n  public getAccessToken(): Promise<AccessToken> {\n    if (this.accessToken) {\n      return Promise.resolve(this.accessToken);\n    }\n    return Promise.reject(new Error('Access token could not be found'));\n  }\n\n  /**\n   * Prepares a new XMLHttpRequest with the proper headers\n   * @returns Request object that is ready for a payload.\n   */\n  private prepareRequest(): Promise<XMLHttpRequest> {\n    const request = new XMLHttpRequest();\n    request.open('POST', this.host, true);\n    request.setRequestHeader('Content-Type', 'application/json');\n\n    const headers = this.headers;\n    if (headers) {\n      headers.forEach((header) => {\n        request.setRequestHeader(header.name, header.value);\n      });\n    }\n\n    return this.getAccessToken().then(accessToken => {\n      request.setRequestHeader('Authorization', `Bearer ${accessToken.token}`);\n      return request;\n    });\n  }\n\n  public send(payload: any, callback: any): void {\n    this.prepareRequest().then(request => {\n      console.log(payload);\n      request.onreadystatechange = () => {\n          if (request.readyState === 4 && request.timeout !== 1) {\n              var result = request.responseText;\n              var error;\n\n              try {\n                  result = JSON.parse(result);\n              } catch(e) {\n                  error = new Error(`Could not parse response: ${request.responseText}`);\n              }\n              callback(error, result);\n          }\n      };\n\n      request.ontimeout = () => {\n          callback(new Error(`Connection timed out: ${this.timeout}`));\n      };\n\n      try {\n          request.send(JSON.stringify(payload));\n      } catch(error) {\n          callback(new Error(`Could not connect to host ${this.host}`));\n      }\n\n    }).catch(err => {\n      callback(err);\n    });\n  }\n\n  /**\n   * Send a web3 / JSON-RPC request asynchronously.\n   * @param payload The JSON-RPC request object to send\n   * @param callback Handler function invoked when the request has completed.\n   */\n  public sendAsync(payload: any, callback: any): void {\n    return this.send(payload, callback);\n  }\n\n  /**\n   * Check whether we are connected to the server.\n   * @returns boolean if we are connected.\n   */\n  public connected(): boolean {\n    return true;\n  }\n}\n","import { AccessToken } from './access-token';\nimport { OAuthHttpProvider } from './oauth-http-provider';\nimport OAuth2 from 'simple-oauth2';\n\nconst BITSKI_API_V1_HOST = 'https://api.bitski.com/v1';\n\n/**\n * A Web3 provider that connects to the Bitski service\n */\nexport class BitskiProvider extends OAuthHttpProvider {\n\n  private networkName: string;\n  private settings: any;\n  private oauthClient: any;\n\n  /**\n   * @param networkName Network name\n   * @param opts Options\n   */\n  constructor(networkName: string = 'mainnet', opts: object) {\n    let settings: any = {\n      client: {\n        id: null,\n        secret: null\n      },\n      auth: {\n        tokenHost: 'https://account.bitski.com',\n        tokenPath: '/oauth2/token'\n      },\n      tokenConfig: {\n        scope: 'eth_sign'\n      }\n    };\n    Object.assign(settings, opts);\n    if (settings.client.id && settings.additionalHeaders) {\n      settings.additionalHeaders.push({name: 'X-Client-Id'})\n    } else if (settings.client.id) {\n      settings.additionalHeaders = [{name: 'X-Client-Id', value: settings.client.id }];\n    }\n    const rpcURL = `${BITSKI_API_V1_HOST}/web3/${networkName}`;\n    super(rpcURL, 0, settings.additionalHeaders);\n    this.oauthClient = OAuth2.create({ client: settings.client, auth: settings.auth });\n    this.networkName = networkName;\n    this.settings = settings;\n  }\n\n  public getAccessToken(): Promise<AccessToken> {\n    if (this.accessToken && this.accessToken.expired === false) {\n      return Promise.resolve(this.accessToken);\n    }\n    return this.oauthClient.clientCredentials.getToken(this.settings.tokenConfig).then(accessTokenResult => {\n      const token = this.oauthClient.accessToken.create(accessTokenResult).token;\n      const accessToken = new AccessToken(token.access_token, parseInt(token.expires_in));\n      this.setAccessToken(accessToken);\n      return accessToken;\n    });\n  }\n}\n"],"names":["tslib_1.__extends"],"mappings":"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"}